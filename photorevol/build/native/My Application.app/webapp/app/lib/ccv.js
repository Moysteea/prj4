if(parallable===undefined){var parallable=function(b,a){parallable.core[a.toString()]=a().core;return function(){var d;var f,c,h;if(arguments.length>1){f=arguments[arguments.length-2];c=arguments[arguments.length-1];h=new Array(arguments.length-2);for(d=0;d<arguments.length-2;d++){h[d]=arguments[d]}}else{f=arguments[0].async;c=arguments[0].worker;h=arguments[0];delete h.async;delete h.worker;h=[h]}var e={shared:{}};var g=a.apply(e,h);if(f){return function(j,k){var l=0;var p=new Array(c);var i=g.pre.apply(e,[c]);for(d in e.shared){if(typeof e.shared[d]=="function"){delete e.shared[d]}else{if(e.shared[d].tagName!==undefined){delete e.shared[d]}}}for(d=0;d<c;d++){var o=new Worker(b);o.onmessage=(function(q){return function(r){p[q]=(typeof r.data=="string")?JSON.parse(r.data):r.data;l++;if(l==c){j(g.post.apply(e,[p]))}}})(d);var n={input:i[d],name:a.toString(),shared:e.shared,id:d,worker:h.worker_num};try{o.postMessage(n)}catch(m){o.postMessage(JSON.stringify(n))}}}}else{return g.post.apply(e,[[g.core.apply(e,[g.pre.apply(e,[1])[0],0,1])]])}}};parallable.core={}}function get_named_arguments(d,c){if(d.length>1){var a={};for(var b=0;b<c.length;b++){a[c[b]]=d[b]}return a}else{if(d.length==1){return d[0]}else{return{}}}}var ccv={pre:function(c){if(c.tagName.toLowerCase()=="img"){var b=document.createElement("canvas");document.body.appendChild(c);b.width=c.width;b.height=c.height;var a=b.getContext("2d");a.drawImage(c,0,0);return b}return c},grayscale:function(b){var a=b.getContext("2d");var g=a.getImageData(0,0,b.width,b.height);var f=g.data;var e,d,c=b.width*b.height*4;while(c>0){f[c-=4]=f[e=c+1]=f[d=c+2]=(f[c]*0.3+f[e]*0.59+f[d]*0.11)}a.putImageData(g,0,0);return b},array_group:function(n,c){var e,d;var b=new Array(n.length);for(e=0;e<n.length;e++){b[e]={parent:-1,element:n[e],rank:0}}for(e=0;e<n.length;e++){if(!b[e].element){continue}var f=e;while(b[f].parent!=-1){f=b[f].parent}for(d=0;d<n.length;d++){if(e!=d&&b[d].element&&c(b[e].element,b[d].element)){var g=d;while(b[g].parent!=-1){g=b[g].parent}if(g!=f){if(b[f].rank>b[g].rank){b[g].parent=f}else{b[f].parent=g;if(b[f].rank==b[g].rank){b[g].rank++}f=g}var l,k=d;while(b[k].parent!=-1){l=k;k=b[k].parent;b[l].parent=f}k=e;while(b[k].parent!=-1){l=k;k=b[k].parent;b[l].parent=f}}}}}var h=new Array(n.length);var a=0;for(e=0;e<n.length;e++){d=-1;var m=e;if(b[m].element){while(b[m].parent!=-1){m=b[m].parent}if(b[m].rank>=0){b[m].rank=~a++}d=~b[m].rank}h[e]=d}return{index:h,cat:a}},detect_objects:parallable("ccv.js",function(a,h,b,c){if(this.shared!==undefined){var f=get_named_arguments(arguments,["canvas","cascade","interval","min_neighbors"]);this.shared.canvas=f.canvas;this.shared.interval=f.interval;this.shared.min_neighbors=f.min_neighbors;this.shared.cascade=f.cascade;this.shared.scale=Math.pow(2,1/(f.interval+1));this.shared.next=f.interval+1;this.shared.scale_upto=Math.floor(Math.log(Math.min(f.canvas.width/f.cascade.width,f.canvas.height/f.cascade.height))/Math.log(this.shared.scale));var g;for(g=0;g<this.shared.cascade.stage_classifier.length;g++){this.shared.cascade.stage_classifier[g].orig_feature=this.shared.cascade.stage_classifier[g].feature}}function e(m){var k=this.shared.canvas;var l=this.shared.interval;var n=this.shared.scale;var q=this.shared.next;var r=this.shared.scale_upto;var o=new Array((r+q*2)*4);var s=new Array((r+q*2)*4);o[0]=k;s[0]={width:o[0].width,height:o[0].height,data:o[0].getContext("2d").getImageData(0,0,o[0].width,o[0].height).data};var p;for(p=1;p<=l;p++){o[p*4]=document.createElement("canvas");o[p*4].width=Math.floor(o[0].width/Math.pow(n,p));o[p*4].height=Math.floor(o[0].height/Math.pow(n,p));o[p*4].getContext("2d").drawImage(o[0],0,0,o[0].width,o[0].height,0,0,o[p*4].width,o[p*4].height);s[p*4]={width:o[p*4].width,height:o[p*4].height,data:o[p*4].getContext("2d").getImageData(0,0,o[p*4].width,o[p*4].height).data}}for(p=q;p<r+q*2;p++){o[p*4]=document.createElement("canvas");o[p*4].width=Math.floor(o[p*4-q*4].width/2);o[p*4].height=Math.floor(o[p*4-q*4].height/2);o[p*4].getContext("2d").drawImage(o[p*4-q*4],0,0,o[p*4-q*4].width,o[p*4-q*4].height,0,0,o[p*4].width,o[p*4].height);s[p*4]={width:o[p*4].width,height:o[p*4].height,data:o[p*4].getContext("2d").getImageData(0,0,o[p*4].width,o[p*4].height).data}}for(p=q*2;p<r+q*2;p++){o[p*4+1]=document.createElement("canvas");o[p*4+1].width=Math.floor(o[p*4-q*4].width/2);o[p*4+1].height=Math.floor(o[p*4-q*4].height/2);o[p*4+1].getContext("2d").drawImage(o[p*4-q*4],1,0,o[p*4-q*4].width-1,o[p*4-q*4].height,0,0,o[p*4+1].width-2,o[p*4+1].height);s[p*4+1]={width:o[p*4+1].width,height:o[p*4+1].height,data:o[p*4+1].getContext("2d").getImageData(0,0,o[p*4+1].width,o[p*4+1].height).data};o[p*4+2]=document.createElement("canvas");o[p*4+2].width=Math.floor(o[p*4-q*4].width/2);o[p*4+2].height=Math.floor(o[p*4-q*4].height/2);o[p*4+2].getContext("2d").drawImage(o[p*4-q*4],0,1,o[p*4-q*4].width,o[p*4-q*4].height-1,0,0,o[p*4+2].width,o[p*4+2].height-2);s[p*4+2]={width:o[p*4+2].width,height:o[p*4+2].height,data:o[p*4+2].getContext("2d").getImageData(0,0,o[p*4+2].width,o[p*4+2].height).data};o[p*4+3]=document.createElement("canvas");o[p*4+3].width=Math.floor(o[p*4-q*4].width/2);o[p*4+3].height=Math.floor(o[p*4-q*4].height/2);o[p*4+3].getContext("2d").drawImage(o[p*4-q*4],1,1,o[p*4-q*4].width-1,o[p*4-q*4].height-1,0,0,o[p*4+3].width-2,o[p*4+3].height-2);s[p*4+3]={width:o[p*4+3].width,height:o[p*4+3].height,data:o[p*4+3].getContext("2d").getImageData(0,0,o[p*4+3].width,o[p*4+3].height).data}}return[s]}function d(C,N,o){var H=this.shared.cascade;var r=this.shared.interval;var J=this.shared.scale;var t=this.shared.next;var s=this.shared.scale_upto;var Y,X,W,P,O,R;var A=1,z=1;var w=[0,1,0,1];var v=[0,0,1,1];var G=[];for(Y=0;Y<s;Y++){var V=C[Y*4+t*8].width-Math.floor(H.width/4);var m=C[Y*4+t*8].height-Math.floor(H.height/4);var L=[C[Y*4].width*4,C[Y*4+t*4].width*4,C[Y*4+t*8].width*4];var Q=[C[Y*4].width*16-V*16,C[Y*4+t*4].width*8-V*8,C[Y*4+t*8].width*4-V*4];for(X=0;X<H.stage_classifier.length;X++){var D=H.stage_classifier[X].orig_feature;var M=H.stage_classifier[X].feature=new Array(H.stage_classifier[X].count);for(W=0;W<H.stage_classifier[X].count;W++){M[W]={size:D[W].size,px:new Array(D[W].size),pz:new Array(D[W].size),nx:new Array(D[W].size),nz:new Array(D[W].size)};for(R=0;R<D[W].size;R++){M[W].px[R]=D[W].px[R]*4+D[W].py[R]*L[D[W].pz[R]];M[W].pz[R]=D[W].pz[R];M[W].nx[R]=D[W].nx[R]*4+D[W].ny[R]*L[D[W].nz[R]];M[W].nz[R]=D[W].nz[R]}}}for(R=0;R<4;R++){var B=[C[Y*4].data,C[Y*4+t*4].data,C[Y*4+t*8+R].data];var l=[w[R]*8+v[R]*C[Y*4].width*8,w[R]*4+v[R]*C[Y*4+t*4].width*4,0];for(O=0;O<m;O++){for(P=0;P<V;P++){var E=0;var K=true;for(X=0;X<H.stage_classifier.length;X++){E=0;var U=H.stage_classifier[X].alpha;var M=H.stage_classifier[X].feature;for(W=0;W<H.stage_classifier[X].count;W++){var F=M[W];var S,aa=B[F.pz[0]][l[F.pz[0]]+F.px[0]];var T,I=B[F.nz[0]][l[F.nz[0]]+F.nx[0]];if(aa<=I){E+=U[W*2]}else{var Z,u=true;for(Z=0;Z<F.size;Z++){if(F.pz[Z]>=0){S=B[F.pz[Z]][l[F.pz[Z]]+F.px[Z]];if(S<aa){if(S<=I){u=false;break}aa=S}}if(F.nz[Z]>=0){T=B[F.nz[Z]][l[F.nz[Z]]+F.nx[Z]];if(T>I){if(aa<=T){u=false;break}I=T}}}E+=(u)?U[W*2+1]:U[W*2]}}if(E<H.stage_classifier[X].threshold){K=false;break}}if(K){G.push({x:(P*4+w[R]*2)*A,y:(O*4+v[R]*2)*z,width:H.width*A,height:H.height*z,neighbor:1,confidence:E})}l[0]+=16;l[1]+=8;l[2]+=4}l[0]+=Q[0];l[1]+=Q[1];l[2]+=Q[2]}}A*=J;z*=J}return G}function j(s){var r=this.shared.min_neighbors;var m=this.shared.cascade;var E=this.shared.interval;var F=this.shared.scale;var u=this.shared.next;var k=this.shared.scale_upto;var C,z;for(C=0;C<m.stage_classifier.length;C++){m.stage_classifier[C].feature=m.stage_classifier[C].orig_feature}s=s[0];if(!(r>0)){return s}else{var p=ccv.array_group(s,function(n,i){var G=Math.floor(n.width*0.25+0.5);return i.x<=n.x+G&&i.x>=n.x-G&&i.y<=n.y+G&&i.y>=n.y-G&&i.width<=Math.floor(n.width*1.5+0.5)&&Math.floor(i.width*1.5+0.5)>=n.width});var y=p.cat;var A=p.index;var t=new Array(y+1);for(C=0;C<t.length;C++){t[C]={neighbors:0,x:0,y:0,width:0,height:0,confidence:0}}for(C=0;C<s.length;C++){var D=s[C];var q=A[C];if(t[q].neighbors==0){t[q].confidence=D.confidence}++t[q].neighbors;t[q].x+=D.x;t[q].y+=D.y;t[q].width+=D.width;t[q].height+=D.height;t[q].confidence=Math.max(t[q].confidence,D.confidence)}var o=[];for(C=0;C<y;C++){var w=t[C].neighbors;if(w>=r){o.push({x:(t[C].x*2+w)/(2*w),y:(t[C].y*2+w)/(2*w),width:(t[C].width*2+w)/(2*w),height:(t[C].height*2+w)/(2*w),neighbors:t[C].neighbors,confidence:t[C].confidence})}}var v=[];for(C=0;C<o.length;C++){var D=o[C];var B=true;for(z=0;z<o.length;z++){var x=o[z];var l=Math.floor(x.width*0.25+0.5);if(C!=z&&D.x>=x.x-l&&D.y>=x.y-l&&D.x+D.width<=x.x+x.width+l&&D.y+D.height<=x.y+x.height+l&&(x.neighbors>Math.max(3,D.neighbors)||D.neighbors<3)){B=false;break}}if(B){v.push(D)}}return v}}return{pre:e,core:d,post:j}})};onmessage=function(c){var d=(typeof c.data=="string")?JSON.parse(c.data):c.data;var b={shared:d.shared};var a=parallable.core[d.name].apply(b,[d.input,d.id,d.worker]);try{postMessage(a)}catch(f){postMessage(JSON.stringify(a))}};